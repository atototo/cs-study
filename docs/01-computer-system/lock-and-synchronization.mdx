---
sidebar_position: 3
title: "ğŸ”’ Lockê³¼ ë™ê¸°í™”"
description: "Race Condition, Lock ì¢…ë¥˜, Deadlockê¹Œì§€ ì¸í„°ë™í‹°ë¸Œí•˜ê²Œ ë°°ìš°ê¸°"
---

import BrowserOnly from '@docusaurus/BrowserOnly';

# ğŸ”’ Lockê³¼ ë™ê¸°í™” (Synchronization)

ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ **ê³µìœ  ìì›**ì„ ì•ˆì „í•˜ê²Œ ë‹¤ë£¨ëŠ” ë°©ë²•ì„ ì•Œì•„ë´…ë‹ˆë‹¤.

---

## ğŸƒ ì™œ ë™ê¸°í™”ê°€ í•„ìš”í•œê°€?

ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ **ë™ì‹œì— ê°™ì€ ë³€ìˆ˜**ë¥¼ ìˆ˜ì •í•˜ë©´ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ê°€ ë°œìƒí•©ë‹ˆë‹¤.

<BrowserOnly>
  {() => {
    const RaceConditionDemo = require('@site/src/components/RaceConditionDemo').default;
    return <RaceConditionDemo />;
  }}
</BrowserOnly>

### í•µì‹¬ ê°œë…: ì„ê³„ ì˜ì—­ (Critical Section)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Thread-1    â”‚  Critical Section  â”‚  Thread-2    â”‚
â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  â”‚ count++;    â”‚   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚   ì§„ì… ì‹œë„   â”‚  â”‚ (ê³µìœ  ìì›)  â”‚   â”‚  ì§„ì… ì‹œë„   â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚              â”‚
â”‚              â”‚                    â”‚              â”‚
â”‚              â”‚  ğŸ” Lockìœ¼ë¡œ ë³´í˜¸  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **ì„ê³„ ì˜ì—­**: ê³µìœ  ìì›ì— ì ‘ê·¼í•˜ëŠ” ì½”ë“œ ë¸”ë¡
- **ìƒí˜¸ ë°°ì œ**: í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì§„ì… í—ˆìš©
- **ë™ê¸°í™”**: ìŠ¤ë ˆë“œ ê°„ ì‹¤í–‰ ìˆœì„œë¥¼ ì¡°ìœ¨

---

## ğŸ” Lockì˜ ì¢…ë¥˜

ë™ê¸°í™”ë¥¼ ìœ„í•œ ë‹¤ì–‘í•œ ë„êµ¬ë“¤ì˜ íŠ¹ì§•ê³¼ ì‚¬ìš© ì‚¬ë¡€ë¥¼ ë¹„êµí•´ë´…ë‹ˆë‹¤.

<BrowserOnly>
  {() => {
    const LockTypesVisual = require('@site/src/components/LockTypesVisual').default;
    return <LockTypesVisual />;
  }}
</BrowserOnly>

### Mutex vs Semaphore í•µì‹¬ ì°¨ì´

| êµ¬ë¶„ | Mutex | Semaphore |
|------|-------|-----------|
| **ë¹„ìœ ** | í™”ì¥ì‹¤ ì—´ì‡  (1ê°œ) | ë†€ì´ê¸°êµ¬ í‹°ì¼“ (Nê°œ) |
| **ë™ì‹œ ì ‘ê·¼** | 1ê°œë§Œ | Nê°œê¹Œì§€ |
| **ì†Œìœ ê¶Œ** | ì ê·¼ ìŠ¤ë ˆë“œë§Œ í•´ì œ ê°€ëŠ¥ | ëˆ„êµ¬ë‚˜ signal ê°€ëŠ¥ |
| **ìš©ë„** | ìƒí˜¸ ë°°ì œ | ìì› í’€ ê´€ë¦¬ |

---

## â˜• Java ë™ê¸°í™” ë„êµ¬

### 1. synchronized (ì•”ë¬µì  Lock)

```java
// ë°©ë²• 1: ë©”ì„œë“œ ë™ê¸°í™”
public synchronized void increment() {
    count++;
}

// ë°©ë²• 2: ë¸”ë¡ ë™ê¸°í™” (ë” ì„¸ë°€í•œ ì œì–´)
public void increment() {
    synchronized(this) {
        count++;
    }
}

// ë°©ë²• 3: í´ë˜ìŠ¤ ë ˆë²¨ (static ë©”ì„œë“œ)
public static synchronized void staticMethod() {
    // í´ë˜ìŠ¤ë‹¹ í•˜ë‚˜ì˜ Lock
}
```

### 2. ReentrantLock (ëª…ì‹œì  Lock)

```java
private final ReentrantLock lock = new ReentrantLock();

public void increment() {
    lock.lock();  // ëª…ì‹œì  íšë“
    try {
        count++;
    } finally {
        lock.unlock();  // ë°˜ë“œì‹œ finallyì—ì„œ í•´ì œ!
    }
}

// tryLockìœ¼ë¡œ Deadlock ë°©ì§€
if (lock.tryLock(1, TimeUnit.SECONDS)) {
    try {
        // ì‘ì—… ìˆ˜í–‰
    } finally {
        lock.unlock();
    }
} else {
    // íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
}
```

### synchronized vs ReentrantLock ë¹„êµ

| ê¸°ëŠ¥ | synchronized | ReentrantLock |
|------|--------------|---------------|
| **ì‚¬ìš©ë²•** | ê°„ë‹¨ (í‚¤ì›Œë“œ) | ë³µì¡ (try-finally í•„ìˆ˜) |
| **íƒ€ì„ì•„ì›ƒ** | âŒ | âœ… tryLock(timeout) |
| **ì¸í„°ëŸ½íŠ¸** | âŒ | âœ… lockInterruptibly() |
| **ê³µì •ì„±** | âŒ | âœ… new ReentrantLock(true) |
| **Condition** | wait/notify | âœ… ë‹¤ì¤‘ Condition ì§€ì› |
| **ì„±ëŠ¥** | JVM ìµœì í™” | ë¹„ìŠ· (Java 6 ì´í›„) |

:::tip ì‹¤ë¬´ ì„ íƒ ê¸°ì¤€
- **ë‹¨ìˆœ ë™ê¸°í™”**: `synchronized` (ê°„ê²°í•˜ê³  ì•ˆì „)
- **íƒ€ì„ì•„ì›ƒ/ì¸í„°ëŸ½íŠ¸ í•„ìš”**: `ReentrantLock`
- **ì½ê¸° ë§ì€ ê²½ìš°**: `ReentrantReadWriteLock`
:::

---

## ğŸ—„ï¸ DB Lock (ë°ì´í„°ë² ì´ìŠ¤)

### Pessimistic Lock (ë¹„ê´€ì  ì ê¸ˆ)

```sql
-- ì¡°íšŒ ì‹œì ì— Lock íšë“ (ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ ëŒ€ê¸°)
SELECT * FROM product WHERE id = 1 FOR UPDATE;

-- ìˆ˜ì •
UPDATE product SET stock = stock - 1 WHERE id = 1;

COMMIT;  -- Lock í•´ì œ
```

```java
// JPA
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT p FROM Product p WHERE p.id = :id")
Product findByIdWithLock(@Param("id") Long id);
```

### Optimistic Lock (ë‚™ê´€ì  ì ê¸ˆ)

```java
@Entity
public class Product {
    @Id
    private Long id;
    
    @Version  // ë²„ì „ ì»¬ëŸ¼ ìë™ ê´€ë¦¬
    private Long version;
    
    private int stock;
}
```

```sql
-- ìˆ˜ì • ì‹œ ë²„ì „ ì²´í¬
UPDATE product 
SET stock = stock - 1, version = version + 1 
WHERE id = 1 AND version = 5;

-- ì˜í–¥ë°›ì€ í–‰ì´ 0ì´ë©´ â†’ OptimisticLockException
```

### Pessimistic vs Optimistic ë¹„êµ

| êµ¬ë¶„ | Pessimistic | Optimistic |
|------|-------------|------------|
| **ì „ëµ** | ì¶©ëŒí•  ê²ƒì´ë‹¤ (ë¯¸ë¦¬ ì ê¸ˆ) | ì¶©ëŒ ì•ˆ í•  ê²ƒì´ë‹¤ (ë‚˜ì¤‘ì— ì²´í¬) |
| **Lock ì‹œì ** | ì¡°íšŒ ì‹œ | ì»¤ë°‹ ì‹œ |
| **ë™ì‹œì„±** | ë‚®ìŒ (ëŒ€ê¸° ë°œìƒ) | ë†’ìŒ |
| **ì¶©ëŒ ì²˜ë¦¬** | ëŒ€ê¸° | ì˜ˆì™¸ â†’ ì¬ì‹œë„ |
| **ì í•©í•œ ê²½ìš°** | ì¶©ëŒ ë¹ˆë²ˆ, ì§§ì€ íŠ¸ëœì­ì…˜ | ì¶©ëŒ ë“œë¬¾, ì½ê¸° ë§ìŒ |

:::info ì‹¤ë¬´ ì„ íƒ ê°€ì´ë“œ
- **ì¬ê³  ì°¨ê°** (ë™ì‹œ ì£¼ë¬¸ ë§ìŒ): Pessimistic Lock
- **ê²Œì‹œê¸€ ìˆ˜ì •** (ì¶©ëŒ ë“œë¬¾): Optimistic Lock
- **ì¢Œì„ ì˜ˆì•½**: Pessimistic + íƒ€ì„ì•„ì›ƒ
:::

---

## ğŸ’€ Deadlock (êµì°© ìƒíƒœ)

ë‘ ìŠ¤ë ˆë“œê°€ ì„œë¡œì˜ Lockì„ ê¸°ë‹¤ë¦¬ë©° ì˜ì›íˆ ë©ˆì¶”ëŠ” ìƒíƒœì…ë‹ˆë‹¤.

<BrowserOnly>
  {() => {
    const DeadlockDemo = require('@site/src/components/DeadlockDemo').default;
    return <DeadlockDemo />;
  }}
</BrowserOnly>

### Deadlock ì½”ë“œ ì˜ˆì‹œ

```java
// âŒ Deadlock ë°œìƒ ê°€ëŠ¥!
// Thread-1: lockA â†’ lockB ìˆœì„œ
// Thread-2: lockB â†’ lockA ìˆœì„œ

// Thread-1
synchronized(lockA) {
    Thread.sleep(100);
    synchronized(lockB) {  // Thread-2ê°€ lockB ë³´ìœ  ì¤‘ â†’ ëŒ€ê¸°
        // ì‘ì—…
    }
}

// Thread-2 (ë™ì‹œ ì‹¤í–‰)
synchronized(lockB) {
    Thread.sleep(100);
    synchronized(lockA) {  // Thread-1ì´ lockA ë³´ìœ  ì¤‘ â†’ ëŒ€ê¸°
        // ì‘ì—…
    }
}
// â†’ ì„œë¡œ ì˜ì›íˆ ëŒ€ê¸° ğŸ’€
```

### Deadlock ì˜ˆë°© íŒ¨í„´

```java
// âœ… í•´ê²°: Lock ìˆœì„œ ê³ ì • (í•­ìƒ A â†’ B)
public void method1() {
    synchronized(lockA) {
        synchronized(lockB) {
            // ì‘ì—…
        }
    }
}

public void method2() {
    synchronized(lockA) {  // Bê°€ ì•„ë‹Œ A ë¨¼ì €!
        synchronized(lockB) {
            // ì‘ì—…
        }
    }
}
```

---

## ğŸ¯ ë©´ì ‘ ì˜ˆìƒ ì§ˆë¬¸

### Q1: Race Conditionì´ ë­”ê°€ìš”?

> **A**: ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ê³µìœ  ìì›ì— ë™ì‹œ ì ‘ê·¼í•  ë•Œ, ì‹¤í–‰ ìˆœì„œì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§€ëŠ” í˜„ìƒì…ë‹ˆë‹¤. 
> `count++`ëŠ” READ â†’ ADD â†’ WRITE 3ë‹¨ê³„ì¸ë°, ë‘ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— READí•˜ë©´ ê°™ì€ ê°’ì„ ì½ì–´ì„œ í•˜ë‚˜ì˜ ì¦ê°€ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
> `synchronized`ë‚˜ `AtomicInteger`ë¡œ í•´ê²°í•©ë‹ˆë‹¤.

### Q2: synchronizedì™€ ReentrantLock ì°¨ì´ëŠ”?

> **A**: `synchronized`ëŠ” JVMì´ ê´€ë¦¬í•˜ëŠ” ì•”ë¬µì  Lockìœ¼ë¡œ ê°„ë‹¨í•˜ì§€ë§Œ íƒ€ì„ì•„ì›ƒì´ ì—†ìŠµë‹ˆë‹¤.
> `ReentrantLock`ì€ `tryLock(timeout)`ìœ¼ë¡œ Deadlock ë°©ì§€, ë‹¤ì¤‘ Condition ì§€ì› ë“± ì„¸ë°€í•œ ì œì–´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
> ë‹¨ìˆœí•œ ê²½ìš° synchronized, íƒ€ì„ì•„ì›ƒ í•„ìš”ì‹œ ReentrantLockì„ ì”ë‹ˆë‹¤.

### Q3: Deadlock ë°œìƒ ì¡°ê±´ê³¼ í•´ê²°ë²•ì€?

> **A**: 4ê°€ì§€ ì¡°ê±´(ìƒí˜¸ë°°ì œ, ì ìœ ëŒ€ê¸°, ë¹„ì„ ì , ìˆœí™˜ëŒ€ê¸°)ì´ **ëª¨ë‘** ì¶©ì¡±ë˜ë©´ ë°œìƒí•©ë‹ˆë‹¤.
> í•´ê²°ë²•:
> 1. **Lock ìˆœì„œ ê³ ì •**: í•­ìƒ ê°™ì€ ìˆœì„œë¡œ íšë“
> 2. **tryLock + íƒ€ì„ì•„ì›ƒ**: ì¼ì • ì‹œê°„ í›„ í¬ê¸°í•˜ê³  ì¬ì‹œë„
> 3. **í•œ ë²ˆì— ëª¨ë“  Lock íšë“**: ì ìœ ëŒ€ê¸° ì¡°ê±´ ì œê±°

### Q4: Pessimistic vs Optimistic Lock ì–¸ì œ ì“°ë‚˜ìš”?

> **A**: 
> - **Pessimistic**: ì¶©ëŒì´ ìì£¼ ë°œìƒí•˜ëŠ” ê²½ìš° (ì¬ê³  ì°¨ê°, ì¢Œì„ ì˜ˆì•½)
> - **Optimistic**: ì¶©ëŒì´ ë“œë¬¸ ê²½ìš° (ê²Œì‹œê¸€ ìˆ˜ì •, ì„¤ì • ë³€ê²½)
> 
> Pessimisticì€ ëŒ€ê¸° ë¹„ìš©, Optimisticì€ ì¬ì‹œë„ ë¹„ìš©ì´ ë°œìƒí•©ë‹ˆë‹¤.
> íŠ¸ë˜í”½ íŒ¨í„´ì— ë”°ë¼ ì„ íƒí•©ë‹ˆë‹¤.

### Q5: Javaì—ì„œ Thread-safeí•œ ìë£Œêµ¬ì¡°ëŠ”?

> **A**: 
> - `ConcurrentHashMap`: ì„¸ê·¸ë¨¼íŠ¸ ë‹¨ìœ„ Lockìœ¼ë¡œ ë†’ì€ ë™ì‹œì„±
> - `CopyOnWriteArrayList`: ì½ê¸° ë§ê³  ì“°ê¸° ì ì„ ë•Œ
> - `BlockingQueue`: ìƒì‚°ì-ì†Œë¹„ì íŒ¨í„´
> - `AtomicInteger/Long`: CAS ê¸°ë°˜ Lock-free ì—°ì‚°

---

## ğŸ“š í•µì‹¬ ì •ë¦¬

```
ë™ê¸°í™”ê°€ í•„ìš”í•œ ì´ìœ 
â””â”€â”€ Race Condition: ê³µìœ  ìì› ë™ì‹œ ì ‘ê·¼ ë¬¸ì œ

Lock ì¢…ë¥˜
â”œâ”€â”€ Mutex: 1ê°œë§Œ ì§„ì… (synchronized)
â”œâ”€â”€ Semaphore: Nê°œê¹Œì§€ ì§„ì… (ì»¤ë„¥ì…˜ í’€)
â””â”€â”€ Monitor: Lock + ì¡°ê±´ ë³€ìˆ˜ (wait/notify)

Java ë™ê¸°í™”
â”œâ”€â”€ synchronized: ê°„ë‹¨, JVM ê´€ë¦¬
â””â”€â”€ ReentrantLock: íƒ€ì„ì•„ì›ƒ, ê³µì •ì„±, ë‹¤ì¤‘ Condition

DB Lock
â”œâ”€â”€ Pessimistic: ë¯¸ë¦¬ ì ê¸ˆ, ì¶©ëŒ ë¹ˆë²ˆ ì‹œ
â””â”€â”€ Optimistic: @Version, ì¶©ëŒ ë“œë¬¸ ê²½ìš°

Deadlock
â”œâ”€â”€ 4ê°€ì§€ ì¡°ê±´ ëª¨ë‘ ì¶©ì¡± ì‹œ ë°œìƒ
â””â”€â”€ í•´ê²°: Lock ìˆœì„œ ê³ ì •, tryLock íƒ€ì„ì•„ì›ƒ
```